[build]
  base    = "frontend"
  command = "npm run build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"

[[plugins]]
  package = "@netlify/plugin-nextjs"

-------------------------------------------------------------------


# Netlify deploy – fix “Page not found”
# Part I  – Setup & Deployment Manual

The app lives in **`frontend/`**. Use the config from **Part II** (single `netlify.toml`, plugin in frontend, explicit publish = `.next`).

## Steps in Netlify UI

1. Open your site → **Site configuration** (or **Build & deploy**).
2. Under **Build settings** → **Configure** (or **Edit settings**):
   - **Base directory:** `frontend`
   - **Build command:** `npm run build`
   - **Publish directory:** `.next`
3. **Save**.
4. Go to **Deploys** → **Trigger deploy** → **Clear cache and deploy site**.

## If you still get 404

- In **Deploys**, check the **Build log**: build should succeed from `frontend`, and the Next.js/OpenNext plugin should run without errors.
- Plugin is in `netlify.toml` only; do not add it to package.json (see Part II).


# Part II  – Setup & Deployment Manual

Quick reference so we don’t run into the same issues again. Use this when setting up a new machine, onboarding, or debugging build/deploy.

---

## 1. Building on Windows

**Problem:** `npm run build` fails with something like  
`'NODE_ENV' is not recognized as an internal or external command`.

**Cause:** The build script used Unix-style env set: `NODE_ENV=production next build`, which doesn’t work in Windows cmd/PowerShell.

**Fix:** In `frontend/package.json`, use a Windows-safe build script:

- **Use:** `"build": "next build"`
- **Avoid:** `"build": "NODE_ENV=production next build"`

Next.js already runs in production mode when you run `next build`, so the extra env var isn’t needed.

**Commands (from repo root):**
```powershell
cd frontend
npm run build
npm run start   # optional: run production build locally
```

---

## 2. Next.js security block (CVE-2025-55182) – deploy rejected with HTTP 400

**Problem:** Deploy fails with: *You're currently using a version of Next.js affected by a critical security vulnerability. To protect your project, we're blocking further deploys until you update your Next.js version.*

**Official:** Netlify’s response (CVE-2025-55182 & CVE-2025-66478): https://ntl.fyi/cve-2025-55182 — Use **`npx fix-react2shell-next`** in `frontend/` to check and fix versions; allow automatic updates of the OpenNext Netlify Next.js adapter.

**Cause:** Netlify blocks deploys when `next` (or React) is in a vulnerable range. Use a **patched** Next.js: **15.2.8** (15.2.x), **15.3.8** (15.3.x), **15.4.10**, **15.5.9**, or **16.0.10**. React **19.2.1+**. See https://nextjs.org/blog/security-update-2025-12-11.

**Fix:**

1. In **`frontend/package.json`**, set a patched Next.js and overrides (e.g. 15.3.8):
   - `"next": "15.3.8"`
   - `"react": "^19.2.1"`, `"react-dom": "^19.2.1"`
   - **`"overrides": { "next": "15.3.8" }`** so no dependency can pull in an older Next.js.
2. From repo root: `cd frontend` then `npm install --legacy-peer-deps` so **`frontend/package-lock.json`** is updated.
3. **Commit and push** both `frontend/package.json` and `frontend/package-lock.json`. Netlify builds from the repo — if these aren’t pushed, the deploy will still see the old version.
4. In Netlify: **Deploys → Trigger deploy → Clear cache and deploy site** (must clear cache so Netlify doesn’t reuse old `node_modules`).

If the error persists: (1) On **GitHub**, open your repo and confirm the latest commit on the branch Netlify builds from contains `frontend/package.json` with `"next": "15.3.8"` (or another patched version). If not, commit and push again. (2) In Netlify, use **Clear cache and deploy site**, not a normal deploy. (3) In the build log, confirm the installed `next` version is patched (e.g. 15.3.8). Do not add `@netlify/plugin-nextjs` to package.json; keep it only in `netlify.toml`.

---

## 3. Build script failure – "Build script returned non-zero exit code: 2"

**Problem:** Deploy fails with: *Failed during stage 'building site': Build script returned non-zero exit code: 2*

**Cause:** The build command (`npm run build`) failed. Common causes:
- TypeScript/compilation errors
- Missing dependencies (lockfile out of sync)
- Build script issues (Windows vs Unix paths, env vars)
- Out of memory or timeout
- Next.js configuration errors

**Fix:**

1. **Check the build log** in Netlify: **Deploys → [failed deploy] → Build log**. Scroll to the error output — it will show the actual failure (e.g., TypeScript error, missing module, etc.).

2. **Test locally first** (from repo root):
   ```powershell
   cd frontend
   npm install --legacy-peer-deps
   npm run build
   ```
   Fix any errors locally before deploying.

3. **Common fixes:**
   - **Missing dependencies:** Run `npm install --legacy-peer-deps` in `frontend/`, commit `package-lock.json`, push, then **Clear cache and deploy**.
   - **TypeScript errors:** Fix TS errors locally, commit, push.
   - **Build script:** Ensure `frontend/package.json` has `"build": "next build"` (no `NODE_ENV=production` prefix — see §1).
   - **Out of memory:** Netlify may need more build resources (check plan limits) or optimize the build (reduce dependencies, use dynamic imports).

4. **After fixing locally:**
   - Commit and push the fixes.
   - In Netlify: **Deploys → Trigger deploy → Clear cache and deploy site**.

5. **If the error persists:** Check the build log for the specific error message (e.g., "Cannot find module", "Type error", etc.) and address that issue. The exit code 2 is generic; the log shows the real problem.

**Note:** Always commit and push fixes before redeploying. Netlify builds from the repo, not your local files.

---

## 4. Netlify Deployment (and fixing 404)

**Problem:** Site deploys but shows “Page not found” (Netlify’s 404) for the app or for routes like `/dashboard`.

**Cause:** Next.js lives in the `frontend/` subdirectory. Netlify must use the right base directory, build command, and the Next.js plugin so routing works.

**Fix:**

1. **Single, clean `netlify.toml` at repo root** (no duplicate `[build]` or `[[plugins]]` blocks):

   ```toml
   [build]
     base    = "frontend"
     command = "npm run build"
     publish = ".next"

   [build.environment]
     NODE_VERSION = "20"

   [[plugins]]
     package = "@netlify/plugin-nextjs"
   ```

2. **Plugin**  
   The plugin is declared in `netlify.toml` only. Do **not** add `@netlify/plugin-nextjs` to `frontend/package.json` — it would change the lockfile and break Netlify’s frozen-lockfile install.

3. **Netlify UI**  
   In **Site configuration → Build & deploy → Build settings**, set (or leave as “from netlify.toml”):
   - **Base directory:** `frontend`
   - **Build command:** `npm run build`
   - **Publish directory:** `.next`

4. **Redeploy**  
   Use **Deploys → Trigger deploy → Clear cache and deploy site** after changing config.

If 404 persists, check the deploy log to ensure the build runs from `frontend` and the Next.js/OpenNext plugin runs successfully.

---

## 5. Git Remote and First Push

**Problem:** Need to connect this repo to GitHub and push.

**Steps:**

1. Add the remote (once per repo):
   ```bash
   git remote add origin https://github.com/fxepro/bibleprotege.git
   ```

2. First push (after you have at least one commit):
   ```bash
   git add .
   git commit -m "Initial commit: BibleProtege frontend and docs"
   git push -u origin main
   ```

3. Later sync (no GitHub CLI or Desktop required):
   ```bash
   git add .
   git commit -m "Your message"
   git push
   ```

You don’t need GitHub CLI or GitHub Desktop for normal push/pull; plain Git is enough.

---

## 6. Git Credentials on Windows (after removing CLI/Desktop)

**Problem:** After uninstalling GitHub CLI or GitHub Desktop, Git shows a “CredentialHelperSelector” dialog asking how to store credentials.

**Fix:**

1. Choose **`manager`** (Git Credential Manager).
2. Check **“Always use this from now on”**.
3. Click **Select**.

Git will then store and reuse your GitHub credentials (e.g. via browser or token) for `git push` / `git pull` without asking every time.  
If `manager` isn’t available, **`wincred`** (Windows Credential Manager) is a good fallback.

---

## Quick checklist

| Task                    | Where / What |
|-------------------------|--------------|
| Next.js / React (CVE)   | `frontend/package.json` → `"next": "15.3.8"` (or 15.2.8), overrides; commit + push lockfile; **Clear cache and deploy** |
| Build script failure    | Check Netlify build log for actual error; fix locally (`npm run build`), commit + push, **Clear cache and deploy** |
| Build script            | `frontend/package.json` → `"build": "next build"` |
| Netlify config          | One clean `netlify.toml` at repo root, base = `frontend`, plugin = `@netlify/plugin-nextjs` |
| Netlify plugin          | In `netlify.toml` only (not in package.json) |
| Git remote              | `git remote add origin https://github.com/fxepro/bibleprotege.git` |
| Git credentials (Win)   | CredentialHelperSelector → choose **manager**, “Always use this” |

---

*Last updated from setup session; adjust repo URL or paths if the project structure changes.*
